# ===================================================================
# Qwen-VL 衬砌板异常检测 - 综合实验配置文件 v3.1
# ===================================================================

# -----------------------------------
# 0. 执行模式控制
# -----------------------------------
execution:
  # "integrated": 直接在本进程加载模型（快速调试）
  # "api_client": 走 OpenAI 兼容 API（生产/并发/常驻）
  mode: "integrated"

  # 仅 api_client 时生效
  api_client_settings:
    base_url: "http://localhost:8086/v1"
    model_name: "qwen"
    api_key: "sk-anything"
    # 新增：健壮性
    request_timeout_s: 120          # 单次请求超时（秒）
    max_retries: 3                  # 失败重试次数
    temperature: 0.1
    max_tokens: 2048

# -----------------------------------
# 1. 模型与加载设置（仅 integrated 使用）
# -----------------------------------
model:
  # 模型路径或 Hub 名称
  path: "Qwen/Qwen2.5-VL-Max-Chat"

  # 传给 ChatModel 的参数（已在 run_inference 内做白名单过滤）
  loading_args:
    template: "qwen2_vl"            # Qwen 2/2.5-VL 常用模板
    device_map: "auto"
    trust_remote_code: true
    # 性能/量化（按需）
    flash_attn: "auto"
    quantization_bit: 4
    # 可选：LoRA/Adapter
    adapter_name_or_path: null
    # 可选：推理后端（环境支持时生效）
    infer_backend: "vllm"

# -----------------------------------
# 2. 数据与输出设置
# -----------------------------------
data:
  data_dir: "./my_tunnel_data/"
  output_dir: "./results/"
  results_filename: "auto"
  limit_samples_per_category: 0
  max_samples_total: 10               # ☆ 全局最多推理 10 张
  shuffle: true                       # ☆ 随机打乱后再截取
  seed: 42
# -----------------------------------
# 3. 推理任务控制
# -----------------------------------
inference:
  mode: "full_image"                # 或 "sliced_image"
  use_fewshot: false
  fewshot_examples_dir: "./few_shot_examples/"
  fewshot_limit_per_class: 4
  fewshot_label_hint: false         # ☆ 关闭 few-shot 文本里的“参考判定：异常/正常”
  exclude_fewshot_from_eval: true 
  use_bbox: false                   # 仅 full_image 有效
  # 新增：random_crops
  multi_image_per_round: true   # ← 多图一轮（≤6 窗口）
  inference:
  save_prompt_text: true           # 开启就会把 prompt_text 写进结果
  save_prompt_max_chars: 8000      # 防止超长；你也可以调成 20000
  save_prompt_images: true         # 是否把该次调用送入的图片列表也记下来


slicing:                         # 随机裁剪使用这个段
  include_global: true
  global_downscale_max_side: 1408  # 控制全局视图大小，节省视觉 token
  random_sizes: [512, 768]         # 裂缝细，建议含 512/640/768 等
  random_per_size: 3               # 每个尺寸抽 3 个
  random_jitter: 0.15              # 尺寸±15% 抖动
  max_windows_per_round: 6         # ☆ 严格 ≤ 6
  seed: 42
# -----------------------------------
# 4. BBox 设置（仅 use_bbox=true 时）
# -----------------------------------
bbox_settings:
  source: "auto_generate"
  relative_size: 0.5
  outline_color: "red"
  outline_width: 5

# -----------------------------------
# 5. 切割参数（仅 sliced_image）
# -----------------------------------
slicing:
  slice_size: 768
  slice_overlap: 128

# -----------------------------------
# 6. Prompt 模板配置（不再使用 <image> 或 {image_token}）
# -----------------------------------
prompts:
  system: |
    你是一个谨慎、严谨的隧道结构安全检测工程师，请给出可复核、可落地的判断与依据。

  zero_shot: |
    请严格检查这张衬砌板图片是否存在结构性缺陷（如裂缝、渗水、破损、剥落、异常污染等）。
    请按以下格式输出：
    【判断】: 异常/正常
    【分析】: 说明判断依据；若为异常，请描述类型、位置与严重程度。

  bbox: |
    这张图中已用红框标出重点区域。仅聚焦框内进行判断：
    【判断】: 异常/正常
    【分析】: 说明框内的具体情况、判断依据与不确定性。

  few_shot_base: |
    下面是若干“学习示例”，请参考其判断口径与解释风格完成新图分析：
    --- 示例开始 ---
    {few_shot_examples}
    --- 示例结束 ---

    现在请对新图进行判断：
    【判断】: 异常/正常
    【分析】: 清晰说明理由与位置；保持与示例一致的口径。

  few_shot_with_bbox_base: |
    先学习以下示例的判断标准与表达风格：
    --- 学习示例开始 ---
    {few_shot_examples}
    --- 学习示例结束 ---

    现在仅聚焦新图中的红框区域，完成诊断：
    【判断】: 异常/正常
    【分析】: 解释框内的具体依据、异常类型与位置。

  prompts.multi_crop_base: |
    请逐一判断我提供的多张图像（按顺序编号 #1, #2, ...）。
    每张图按如下格式输出一行：
    【图#k】【判断】: 正常/异常；【理由】: <简要依据>；【定位】: <若能指出区域请描述>

    {few_shot_examples}
