# ===================================================================
# Qwen-VL 衬砌板异常检测 - 综合实验配置文件 v3.1
# ===================================================================

# -----------------------------------
# 0. 执行模式控制
# -----------------------------------
execution:
  # "integrated": 直接在本进程加载模型（快速调试）
  # "api_client": 走 OpenAI 兼容 API（生产/并发/常驻）
  mode: "integrated"

  # 仅 api_client 时生效
  api_client_settings:
    base_url: "http://localhost:8086/v1"
    model_name: "qwen"
    api_key: "sk-anything"
    # 新增：健壮性
    request_timeout_s: 120          # 单次请求超时（秒）
    max_retries: 3                  # 失败重试次数
    temperature: 0.1
    max_tokens: 2048

# -----------------------------------
# 1. 模型与加载设置（仅 integrated 使用）
# -----------------------------------
model:
  # 模型路径或 Hub 名称
  path: "Qwen/Qwen2.5-VL-Max-Chat"

  # 传给 ChatModel 的参数（已在 run_inference 内做白名单过滤）
  loading_args:
    template: "qwen2_vl"            # Qwen 2/2.5-VL 常用模板
    device_map: "auto"
    trust_remote_code: true
    # 性能/量化（按需）
    flash_attn: "auto"
    quantization_bit: 4
    # 可选：LoRA/Adapter
    adapter_name_or_path: null
    # 可选：推理后端（环境支持时生效）
    infer_backend: "vllm"

# -----------------------------------
# 2. 数据与输出设置
# -----------------------------------
data:
  data_dir: "./my_tunnel_data/"
  output_dir: "./results/"
  results_filename: "auto"
  limit_samples_per_category: 0

# -----------------------------------
# 3. 推理任务控制
# -----------------------------------
inference:
  mode: "full_image"                # 或 "sliced_image"
  use_fewshot: false
  fewshot_examples_dir: "./few_shot_examples/"
  fewshot_limit_per_class: 4
  use_bbox: false                   # 仅 full_image 有效

# -----------------------------------
# 4. BBox 设置（仅 use_bbox=true 时）
# -----------------------------------
bbox_settings:
  source: "auto_generate"
  relative_size: 0.5
  outline_color: "red"
  outline_width: 5

# -----------------------------------
# 5. 切割参数（仅 sliced_image）
# -----------------------------------
slicing:
  slice_size: 768
  slice_overlap: 128

# -----------------------------------
# 6. Prompt 模板配置（不再使用 <image> 或 {image_token}）
# -----------------------------------
prompts:
  system: |
    你是一个谨慎、严谨的隧道结构安全检测工程师，请给出可复核、可落地的判断与依据。

  zero_shot: |
    请严格检查这张衬砌板图片是否存在结构性缺陷（如裂缝、渗水、破损、剥落、异常污染等）。
    请按以下格式输出：
    【判断】: 异常/正常
    【分析】: 说明判断依据；若为异常，请描述类型、位置与严重程度。

  bbox: |
    这张图中已用红框标出重点区域。仅聚焦框内进行判断：
    【判断】: 异常/正常
    【分析】: 说明框内的具体情况、判断依据与不确定性。

  few_shot_base: |
    下面是若干“学习示例”，请参考其判断口径与解释风格完成新图分析：
    --- 示例开始 ---
    {few_shot_examples}
    --- 示例结束 ---

    现在请对新图进行判断：
    【判断】: 异常/正常
    【分析】: 清晰说明理由与位置；保持与示例一致的口径。

  few_shot_with_bbox_base: |
    先学习以下示例的判断标准与表达风格：
    --- 学习示例开始 ---
    {few_shot_examples}
    --- 学习示例结束 ---

    现在仅聚焦新图中的红框区域，完成诊断：
    【判断】: 异常/正常
    【分析】: 解释框内的具体依据、异常类型与位置。
